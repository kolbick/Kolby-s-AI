<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kolbyâ€™s AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/style.css?v=kolby-v1" />
</head>
<body>
  <div class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <img src="assets/img/logo.png" alt="Kolby's AI logo" class="brand-logo" />
        <span class="brand-name">Kolbyâ€™s AI</span>
      </div>

      <nav class="sidebar-nav">
        <button class="nav-item active">
          <span class="nav-icon">â˜°</span>
          <span>Models</span>
        </button>
        <button class="nav-item">
          <span class="nav-icon">ðŸ’¬</span>
          <span>Chat</span>
        </button>
        <button class="nav-item">
          <span class="nav-icon">âŸ³</span>
          <span>History</span>
        </button>
        <button class="nav-item">
          <span class="nav-icon">âš™ï¸Ž</span>
          <span>Settings</span>
        </button>
      </nav>

      <div class="sidebar-section">
        <div class="sidebar-section-title">Models</div>
        <ul class="model-list" id="model-list">
          <!-- Filled by JS -->
        </ul>
      </div>
    </aside>

    <!-- MAIN AREA -->
    <main class="main">

      <header class="topbar">
        <h1 class="topbar-title">Kolbyâ€™s AI</h1>
        <button class="btn-outline" id="sign-in-btn">Sign In</button>
      </header>

      <!-- Watermark -->
      <div class="watermark"></div>

      <!-- Chat area (empty until backend) -->
      <section class="chat-shell">

        <div class="chat-empty-message" id="chat-empty">
          <!-- You can change this copy to whatever you like -->
          <p>Select a model on the left and start chatting.</p>
        </div>

        <!-- Note entry area -->
        <form id="note-form" class="note-form">
          <textarea
            id="note-text"
            placeholder="Enter clinical note here..."
            required
          ></textarea>
          <div class="note-actions">
            <button type="button" id="note-generate" class="btn-primary">
              Generate Plan &amp; Summary
            </button>
            <button type="button" id="note-reset" class="btn-ghost">
              Reset Record
            </button>
          </div>
        </form>

        <form class="chat-input-row" id="chat-form">
          <input
            id="chat-input"
            class="chat-input"
            type="text"
            placeholder="Send a message..."
            autocomplete="off"
          />
          <button type="submit" class="btn-primary" id="send-btn">
            Send
          </button>
        </form>

      </section>
    </main>
  </div>

  <!-- Login modal (UI only for now) -->
  <div class="modal-backdrop hidden" id="login-modal">
    <div class="modal">
      <h2>Sign in</h2>
      <p class="modal-subtitle">
        This only controls access level; the actual auth will hook to your backend later.
      </p>
      <form id="login-form">
        <label>
          Email
          <input type="email" id="login-email" required />
        </label>
        <label>
          Password
          <input type="password" id="login-password" required />
        </label>
        <div class="modal-actions">
          <button type="button" class="btn-ghost" id="login-cancel">Cancel</button>
          <button type="submit" class="btn-primary">Continue</button>
        </div>
      </form>
    </div>
  </div>

  <script src="assets/app.js"></script>

  <!-- Inline script to handle note entry and redirect to plan/discharge pages -->
  <script>
    // Maintain patient and discharge records across pages using localStorage
    let patientRecord = JSON.parse(localStorage.getItem('patientRecord') || 'null') || {
      problems: [],
      goals: [],
      interventions: [],
      progress: [],
      barriers: []
    };
    let dischargeRecord = JSON.parse(localStorage.getItem('dischargeRecord') || 'null') || {
      reason: '',
      course: [],
      response: [],
      aftercare: []
    };

    // Simple heuristic parser for clinical notes
    function parseNote(note) {
      const lower = note.toLowerCase();
      const updates = { progress: [], goals: [], interventions: [], problems: [], aftercare: [] };
      const matchSober = lower.match(/(\d+)\s*days?\s*sober/);
      if (matchSober) {
        updates.progress.push(`Client reports ${matchSober[1]} days sober.`);
        if (!patientRecord.goals.includes('Maintain sobriety')) updates.goals.push('Maintain sobriety');
      }
      if (lower.includes('sleep')) {
        if (lower.includes('poor')) {
          if (!patientRecord.problems.includes('Poor sleep hygiene')) updates.problems.push('Poor sleep hygiene');
          if (!patientRecord.goals.includes('Improve sleep hygiene')) updates.goals.push('Improve sleep hygiene');
        } else if (lower.includes('improved')) {
          updates.progress.push('Sleep is improving.');
          if (!patientRecord.goals.includes('Improve sleep hygiene')) updates.goals.push('Improve sleep hygiene');
        }
      }
      if (lower.includes('craving') || lower.includes('coping')) {
        if (!patientRecord.interventions.includes('Coping skills training')) updates.interventions.push('Coping skills training');
        if (!patientRecord.goals.includes('Develop coping skills')) updates.goals.push('Develop coping skills');
      }
      if (lower.includes('trigger')) {
        if (!patientRecord.problems.includes('Identified triggers')) updates.problems.push('Identified triggers');
        if (!patientRecord.goals.includes('Recognize and manage triggers')) updates.goals.push('Recognize and manage triggers');
      }
      if (lower.includes('aftercare') || lower.includes('appointment scheduled')) {
        updates.aftercare.push('Aftercare planning underway.');
      }
      return updates;
    }

    // Apply updates from a new note to the stored record
    function applyUpdates(note) {
      const updates = parseNote(note);
      ['problems', 'goals', 'interventions', 'aftercare'].forEach((field) => {
        updates[field].forEach((item) => {
          if (!patientRecord[field].includes(item)) patientRecord[field].push(item);
        });
      });
      updates.progress.forEach((item) => patientRecord.progress.push(item));
      // Use first two sentences as a summary for discharge course
      const sentences = note.split(/[.!?]/).filter((s) => s.trim().length > 0);
      const summary = sentences.slice(0, 2).join('. ') + '.';
      if (!dischargeRecord.reason) dischargeRecord.reason = 'Client admitted for treatment. Initial presentation: ' + summary;
      dischargeRecord.course.push(summary);
      updates.aftercare.forEach((item) => dischargeRecord.aftercare.push(item));
      localStorage.setItem('patientRecord', JSON.stringify(patientRecord));
      localStorage.setItem('dischargeRecord', JSON.stringify(dischargeRecord));
    }

    // Event listeners for note actions
    document.addEventListener('DOMContentLoaded', () => {
      const generateBtn = document.getElementById('note-generate');
      const resetBtn = document.getElementById('note-reset');
      generateBtn.addEventListener('click', () => {
        const note = document.getElementById('note-text').value.trim();
        if (!note) return;
        applyUpdates(note);
        document.getElementById('note-text').value = '';
        // Redirect to treatment plan page
        window.location.href = 'plan.html';
      });
      resetBtn.addEventListener('click', () => {
        if (!confirm('Are you sure you want to reset the patient record?')) return;
        patientRecord = { problems: [], goals: [], interventions: [], progress: [], barriers: [] };
        dischargeRecord = { reason: '', course: [], response: [], aftercare: [] };
        localStorage.removeItem('patientRecord');
        localStorage.removeItem('dischargeRecord');
        alert('Record reset.');
      });
    });
  </script>
</body>
</html>
