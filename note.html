<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Changing Tides note summarizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="assets/img/kolbysailogo2.png" sizes="32x32" />
  <link rel="apple-touch-icon" href="assets/img/kolbysailogo2.png" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="assets/style.css?v=kolby-v2" />
  <style>
    .note-container {
      max-width: 780px;
      margin: 40px auto;
      padding: 20px 16px 32px;
    }
    textarea {
      width: 100%;
      height: 220px;
      padding: 12px;
      background: #fffdf8;
      border: 1px solid #d8cbb2;
      border-radius: 8px;
      font: inherit;
    }
    .btn { margin-top: 10px; }
    .summary-preview {
      margin-top: 18px;
      padding: 12px;
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      white-space: pre-wrap;
      font-size: 14px;
    }
    .status-row { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
  </style>
</head>

<body>
  <div class="note-container">
    <h1>Changing Tides note summarizer</h1>
    <p>Paste a clinical note and generate structured plan and discharge updates.</p>

    <textarea id="noteInput" placeholder="Paste your clinical note here..."></textarea>

    <div style="display: flex; gap: 8px; align-items: center; margin-top: 10px; flex-wrap: wrap;">
      <button id="generateViewBtn" class="btn btn-primary">Generate Plan Update</button>
      <button id="resetBtn" class="btn btn-ghost" type="button">Reset Stored Records</button>
      <a href="plan.html" class="btn btn-outline">View Treatment Plan</a>
      <a href="discharge.html" class="btn btn-outline">View Discharge Summary</a>
    </div>

    <div class="status-row">
      <div id="statusMessage" class="status-message" hidden></div>
      <div id="postActions" class="actions" hidden>
        <a href="plan.html" class="btn btn-primary">View Treatment Plan</a>
        <a href="discharge.html" class="btn btn-outline">View Discharge Summary</a>
        <a href="index.html" class="btn btn-ghost">Back to Chat</a>
      </div>
    </div>

    <div class="summary-preview" id="previewBox" hidden></div>
  </div>

<script>
/* ==========================================================
   LOCAL STORAGE HELPERS
   ========================================================== */
function loadRecord(key, fallback = {}) {
  try {
    return JSON.parse(localStorage.getItem(key)) || fallback;
  } catch (e) {
    console.warn(`Failed to parse ${key} from storage`, e);
    return fallback;
  }
}

function saveRecord(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}

let patientRecord = loadRecord("patientRecord", {});
let dischargeRecord = loadRecord("dischargeRecord", {});

/* ==========================================================
   BACKEND CONFIG
   ========================================================== */
const OPENWEBUI_URL = "https://kaitlin-unfertilisable-snottily.ngrok-free.dev/api/chat/completions";
const OPENWEBUI_MODEL_ID = "changing-tides-ai-proposal-test";
const OPENWEBUI_JWT = "PyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjM5NWUyNDIyLTk2ZTMtNDlmNi1iYjk2LTU3MTcyMWRjN2NhMCIsImV4cCI6MTc2NzQ3OTYxOSwianRpIjoiYWRhN2RiNTctNGZmZS00YjIwLWIxYTMtZGJkYjBkNzI0OGIxIn0.9f-SW4DckWTAu5cR9yY5wbW8Y3Jpg86xE7WPA4o2h28";

/* ==========================================================
   CALL SUMMARY MODEL
   ========================================================== */
async function callOpenWebUISummary(noteText) {
  console.log("Sending request:", { model: OPENWEBUI_MODEL_ID, url: OPENWEBUI_URL });

  const response = await fetch(OPENWEBUI_URL, {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${OPENWEBUI_JWT}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      model: OPENWEBUI_MODEL_ID,
      messages: [
        {
          role: "system",
          content: "You are the Changing Tides clinical documentation AI. Extract structured JSON: problems, goals, interventions, progress, aftercare, summary."
        },
        { role: "user", content: noteText }
      ]
    })
  });

  if (!response.ok) {
    const text = await response.text();
    console.error("Backend responded with error", response.status, text);
    throw new Error(`Backend responded with status ${response.status}`);
  }

  const data = await response.json();
  const raw = data?.choices?.[0]?.message?.content || "";

  if (!raw) {
    throw new Error("No response from backend.");
  }

  try {
    return JSON.parse(raw);
  } catch (parseError) {
    console.warn("Could not parse JSON from model response; storing raw text instead.", parseError);
    return { summary: raw };
  }
}

/* ==========================================================
   MERGING SUMMARY INTO RECORDS
   ========================================================== */
function mergeSummary(summary) {
  if (!patientRecord.problems) patientRecord.problems = [];

  if (Array.isArray(summary.problems)) {
    patientRecord.problems = summary.problems;
  }

  if (summary.progress) {
    patientRecord.progress = summary.progress;
  }

  if (summary.aftercare) {
    dischargeRecord.aftercare = summary.aftercare;
  }

  if (summary.summary) {
    patientRecord.summary = summary.summary;
  }

  saveRecord("patientRecord", patientRecord);
  saveRecord("dischargeRecord", dischargeRecord);
}

function showPreview(summary) {
  const box = document.getElementById("previewBox");
  box.hidden = false;
  box.textContent = JSON.stringify(summary, null, 2);
}

function setStatus(type, message) {
  const box = document.getElementById("statusMessage");
  if (!box) return;
  box.hidden = false;
  box.className = `status-message status-${type}`;
  box.textContent = message;
}

function resetStatus() {
  const box = document.getElementById("statusMessage");
  if (box) {
    box.hidden = true;
    box.textContent = "";
  }
  const actions = document.getElementById("postActions");
  if (actions) actions.hidden = true;
}

/* ==========================================================
   BUTTON ACTIONS
   ========================================================== */
document.getElementById("generateViewBtn").onclick = async () => {
  const text = document.getElementById("noteInput").value.trim();
  if (!text) return;

  const btn = document.getElementById("generateViewBtn");
  resetStatus();
  btn.disabled = true;
  btn.textContent = "Updating...";
  setStatus("loading", "Updating treatment plan and discharge summary...");

  try {
    const summary = await callOpenWebUISummary(text);
    mergeSummary(summary);
    showPreview(summary);

    setStatus("success", "Plan and discharge summary updated successfully.");
    const actions = document.getElementById("postActions");
    if (actions) actions.hidden = false;

    setTimeout(() => {
      window.location.href = "plan.html";
    }, 1500);
  } catch (e) {
    console.error("Summary request failed:", e);
    setStatus("error", "Error updating plan. Please check connection and try again.");
  } finally {
    btn.disabled = false;
    btn.textContent = "Generate Plan Update";
  }
};

document.getElementById("resetBtn").onclick = () => {
  localStorage.removeItem("patientRecord");
  localStorage.removeItem("dischargeRecord");
  patientRecord = {};
  dischargeRecord = {};
  document.getElementById("previewBox").hidden = true;
  resetStatus();
  alert("Records cleared.");
};
</script>
</body>
</html>
