<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Note Entry – Kolby’s AI</title>
  <!-- Use the shared stylesheet for a consistent look -->
  <link rel="stylesheet" href="assets/style.css?v=kolby-v1" />
  <style>
    /* Additional styles for the note entry page */
    .note-container {
      max-width: 600px;
      margin: 40px auto;
      padding: 0 15px;
    }
    .note-container textarea {
      width: 100%;
      min-height: 180px;
      padding: 10px;
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-md);
      background: var(--bg-input);
      resize: vertical;
    }
    .note-buttons {
      margin-top: 12px;
    }
    .note-buttons button {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="note-container">
    <h1>Enter Clinical Note</h1>
    <p>Paste a clinical note below. When you click “Generate &amp; View Plan” the updated treatment plan and discharge summary will be built using your local model.</p>
    <textarea id="noteInput" placeholder="Paste clinical note here"></textarea>
    <div class="note-buttons">
      <button id="generateViewBtn" class="btn-primary">Generate &amp; View Plan</button>
      <button id="resetBtn" class="btn-ghost">Reset Patient Record</button>
    </div>
  </div>
  <script>
    /*
      Note entry page script

      This page collects a clinical note, calls your local Open WebUI model
      to extract structured information and summary text, then merges the
      results into a patient record saved in localStorage.  The updated
      record powers the treatment plan and discharge summary pages.

      Before using this page, paste your JWT token into the
      OPENWEBUI_JWT constant.  You can find your JWT on the Open WebUI
      Settings → Account page.  See API docs: you can authenticate with a
      JWT or an API key【6884566221690†L23-L27】.
    */
    const OPENWEBUI_JWT = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjM5NWUyNDIyLTk2ZTMtNDlmNi1iYjk2LTU3MTcyMWRjN2NhMCIsImV4cCI6MTc2NzQ3OTYxOSwianRpIjoiYWRhN2RiNTctNGZmZS00YjIwLWIxYTMtZGJkYjBkNzI0OGIxIn0.9f-SW4DckWTAu5cR9yY5wbW8Y3Jpg86xE7WPA4o2h28';
    const OPENWEBUI_URL = 'http://localhost:3000/api/chat/completions';
    // Specify which model should be used for summarising notes.  If your
    // model names change, update this constant accordingly.  This ID
    // must match a workspace model in Open WebUI, for example
    // "Changing Tides AI Proposal (Test)".
    const OPENWEBUI_MODEL_ID = 'Changing Tides AI Proposal (Test)';

    // Load existing records or initialise empty ones
    let patientRecord = JSON.parse(localStorage.getItem('patientRecord') || 'null') || {
      problems: [],
      goals: [],
      interventions: [],
      progress: [],
      barriers: []
    };
    let dischargeRecord = JSON.parse(localStorage.getItem('dischargeRecord') || 'null') || {
      reason: '',
      course: [],
      response: [],
      aftercare: []
    };

    /**
     * Call Open WebUI to summarise a clinical note.  Returns a
     * JavaScript object with keys: problems, goals, interventions,
     * progress, aftercare and summary.  If authentication or parsing
     * fails, returns null and a warning will be printed to the console.
     *
     * @param {string} note The raw note text
     * @returns {Promise<Object|null>} Structured summary or null
     */
    async function callOpenWebUISummary(note) {
      if (!OPENWEBUI_JWT) {
        console.warn('No JWT token set. Please set OPENWEBUI_JWT in note.html.');
        return null;
      }
      try {
        const payload = {
          model: OPENWEBUI_MODEL_ID,
          messages: [
            {
              role: 'system',
              content: `You are a treatment plan assistant. When given a clinical note you should extract the patient's current problems, goals, interventions, progress notes and aftercare items. Also provide a concise summary of the note to append to the course of treatment. Return a valid JSON object with the following keys: "problems", "goals", "interventions", "progress", "aftercare", and "summary". Each value should be an array of strings except for summary which should be a single string. Do not include explanations or any additional keys.`
            },
            { role: 'user', content: note }
          ]
        };
        const response = await fetch(OPENWEBUI_URL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${OPENWEBUI_JWT}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        const data = await response.json();
        const content = data?.choices?.[0]?.message?.content;
        if (!content) throw new Error('No content returned from Open WebUI');
        try {
          return JSON.parse(content);
        } catch (e) {
          console.error('Failed to parse JSON:', content);
          return null;
        }
      } catch (err) {
        console.error('Error calling Open WebUI:', err);
        return null;
      }
    }

    /**
     * Merge the summary returned from the model into the stored
     * patientRecord and dischargeRecord.  If summary is null the
     * function falls back to using the first two sentences of the note
     * as the course of treatment.
     *
     * @param {Object|null} summary Parsed summary object
     * @param {string} note Original clinical note
     */
    function mergeSummaryIntoRecords(summary, note) {
      if (!summary) {
        // Fallback: use first two sentences for the course of treatment
        const sentences = note.split(/[.!?]/).filter((s) => s.trim().length > 0);
        const fallback = sentences.slice(0, 2).join('. ') + '.';
        if (!dischargeRecord.reason) dischargeRecord.reason = 'Client admitted for treatment. Initial presentation: ' + fallback;
        dischargeRecord.course.push(fallback);
        localStorage.setItem('patientRecord', JSON.stringify(patientRecord));
        localStorage.setItem('dischargeRecord', JSON.stringify(dischargeRecord));
        return;
      }
      // Merge lists while avoiding duplicates
      ['problems', 'goals', 'interventions', 'aftercare'].forEach((field) => {
        if (Array.isArray(summary[field])) {
          summary[field].forEach((item) => {
            if (!patientRecord[field].includes(item)) patientRecord[field].push(item);
          });
        }
      });
      if (Array.isArray(summary.progress)) {
        summary.progress.forEach((p) => patientRecord.progress.push(p));
      }
      const summaryText = summary.summary || '';
      if (!dischargeRecord.reason) dischargeRecord.reason = 'Client admitted for treatment. Initial presentation: ' + summaryText;
      if (summaryText) dischargeRecord.course.push(summaryText);
      if (Array.isArray(summary.aftercare)) {
        summary.aftercare.forEach((item) => dischargeRecord.aftercare.push(item));
      }
      // Save to localStorage
      localStorage.setItem('patientRecord', JSON.stringify(patientRecord));
      localStorage.setItem('dischargeRecord', JSON.stringify(dischargeRecord));
    }

    document.getElementById('generateViewBtn').addEventListener('click', () => {
      const note = document.getElementById('noteInput').value.trim();
      if (!note) return;
      (async () => {
        const summary = await callOpenWebUISummary(note);
        mergeSummaryIntoRecords(summary, note);
        document.getElementById('noteInput').value = '';
        window.location.href = 'plan.html';
      })();
    });
    document.getElementById('resetBtn').addEventListener('click', () => {
      if (!confirm('Are you sure you want to reset the patient record?')) return;
      patientRecord = { problems: [], goals: [], interventions: [], progress: [], barriers: [] };
      dischargeRecord = { reason: '', course: [], response: [], aftercare: [] };
      localStorage.removeItem('patientRecord');
      localStorage.removeItem('dischargeRecord');
      alert('Record reset.');
    });
  </script>
</body>
</html>
