<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Note Entry – Changing Tides AI</title>
  <link rel="stylesheet" href="assets/style.css?v=kolby-v1" />
  <style>
    .note-container {
      max-width: 700px;
      margin: 40px auto;
      padding: 20px;
    }
    textarea {
      width: 100%;
      height: 200px;
      padding: 12px;
      background: #fffdf8;
      border: 1px solid #d8cbb2;
      border-radius: 8px;
    }
    .btn { margin-top: 10px; }
  </style>
</head>

<body>
  <div class="note-container">
    <h1>Changing Tides – Clinical Note Summarizer</h1>
    <p>Paste a client note below and click “Generate Plan Update”.</p>

    <textarea id="noteInput" placeholder="Paste your clinical note here..."></textarea>

    <button id="generateViewBtn" class="btn btn-primary">Generate Plan Update</button>
    <button id="resetBtn" class="btn btn-ghost">Reset</button>
  </div>

<script>
/* ==========================================================
   LOCAL STORAGE OBJECTS
   ========================================================== */
let patientRecord = JSON.parse(localStorage.getItem("patientRecord") || "{}");
let dischargeRecord = JSON.parse(localStorage.getItem("dischargeRecord") || "{}");

/* ==========================================================
   BACKEND CONFIG
   ========================================================== */

const OPENWEBUI_URL = "http://localhost:3000/api/chat/completions";
const OPENWEBUI_MODEL_ID = "changing-tides-ai-proposal-test";  
const OPENWEBUI_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjM5NWUyNDIyLTk2ZTMtNDlmNi1iYjk2LTU3MTcyMWRjN2NhMCIsImV4cCI6MTc2NzQ3OTYxOSwianRpIjoiYWRhN2RiNTctNGZmZS00YjIwLWIxYTMtZGJkYjBkNzI0OGIxIn0.9f-SW4DckWTAu5cR9yY5wbW8Y3Jpg86xE7WPA4o2h28";

/* ==========================================================
   CALL SUMMARY MODEL
   ========================================================== */

async function callOpenWebUISummary(noteText) {
  try {
    const response = await fetch(OPENWEBUI_URL, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${OPENWEBUI_JWT}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: OPENWEBUI_MODEL_ID,
        messages: [
          { 
            role: "system", 
            content: "You are the Changing Tides clinical documentation AI. Extract structured JSON: problems, goals, interventions, progress, aftercare, summary." 
          },
          { role: "user", content: noteText }
        ]
      })
    });

    const data = await response.json();
    const raw = data?.choices?.[0]?.message?.content || "";

    try {
      return JSON.parse(raw);
    } catch {
      return { summary: raw };
    }

  } catch (e) {
    return { summary: "Backend error: " + e.message };
  }
}

/* ==========================================================
   MERGING SUMMARY INTO RECORDS
   ========================================================== */

function mergeSummary(summary) {
  if (!patientRecord.problems) patientRecord.problems = [];

  if (summary.problems) {
    patientRecord.problems.push(...summary.problems);
  }
  if (summary.progress) patientRecord.progress = summary.progress;
  if (summary.aftercare) dischargeRecord.aftercare = summary.aftercare;

  localStorage.setItem("patientRecord", JSON.stringify(patientRecord));
  localStorage.setItem("dischargeRecord", JSON.stringify(dischargeRecord));
}

/* ==========================================================
   BUTTON ACTIONS
   ========================================================== */

document.getElementById("generateViewBtn").onclick = async () => {
  const text = document.getElementById("noteInput").value.trim();
  if (!text) return;

  const summary = await callOpenWebUISummary(text);
  mergeSummary(summary);

  window.location.href = "plan.html";
};

document.getElementById("resetBtn").onclick = () => {
  localStorage.removeItem("patientRecord");
  localStorage.removeItem("dischargeRecord");
  alert("Records cleared.");
};
</script>
</body>
</html>
